/*! nodeJS-Server - v0.0.1 - 2015-07-07 */
var express=require("express"),app=express(),bodyParser=require("body-parser"),fs=require("fs"),Book=require("./models/book"),Author=require("./models/author"),notFound={type:"notFound",statusCode:404,msg:"Requested resource not found"},badRequest={type:"badRequest",statusCode:400,msg:"Parameters were wrong"},pubDirName="public";app.use(bodyParser.urlencoded({extended:!0})),app.use(bodyParser.json());var mongoose=require("mongoose");mongoose.connect("mongodb://localhost/mme-ii");var args=process.argv.slice(2),port=parseInt(args[0],10)||1337,router=express.Router(),routing=express.Router(),docRoute=express.Router(),adminRoute=express.Router();router.get("/",function(a,b){"use strict";b.json({message:"hello world"})}),router.route("/books").post(function(a,b){"use strict";var c=[];if("string"==typeof a.body.author){var d=new Author;d.name=a.body.author,c.push(d)}else if("object"==typeof a.body.author)for(var e in a.body.author)if(a.body.author.hasOwnProperty(e)){var f=a.body.author[e],g=new Author;g.name=f,c.push(g)}var h=new Book;c.length>0&&(h.author=c),h.name=a.body.name,h.description=a.body.description,h.ISBN=a.body.ISBN,h.state=a.body.state,h.validate(function(a){return a?(b.statusCode=400,b.json(badRequest)):void h.save(function(a){return a?(b.statusCode=400,b.json(badRequest)):(b.statusCode=201,void b.json(h))})})}).get(function(a,b){"use strict";var c=a.query.rpp||20,d=a.query.page||1;delete a.query.rpp,delete a.query.page,Book.find(a.query).skip((d-1)*c).limit(c).exec(function(a,c){return a?(b.statusCode=400,b.json(badRequest)):(b.statusCode=200,void b.json(c))})}),router.route("/books/:book_id").get(function(a,b){"use strict";Book.findById(a.params.book_id,function(a,c){return a?(b.statusCode=404,b.json(notFound)):null===c?(b.statusCode=404,b.json(notFound)):(b.statusCode=200,void b.json(c))})}).put(function(a,b){"use strict";Book.findById(a.params.book_id,function(c,d){if(c)return b.statusCode=404,b.json(notFound);var e=[];if("string"==typeof a.body.author){var f=new Author;f.name=a.body.author,e.push(f)}else if("object"==typeof a.body.author)for(var g in a.body.author)if(a.body.author.hasOwnProperty(g)){var h=a.body.author[g],i=new Author;i.name=h,e.push(i)}e.length>0&&(d.author=e),d.name=a.body.name,d.description=a.body.description,d.ISBN=a.body.ISBN,d.state=a.body.state,d.validate(function(a){return a?(b.statusCode=400,b.json(badRequest)):void d.save(function(a){return a?(b.statusCode=400,b.json(badRequest)):(b.statusCode=201,void b.json(d))})})})})["delete"](function(a,b){"use strict";Book.findById(a.params.book_id,function(c,d){return c?(b.statusCode=404,b.json(notFound)):null===d?(b.statusCode=404,b.json(notFound)):void d.remove(function(c){return c?(b.statusCode=400,b.json(badRequest)):(b.statusCode=204,void b.json({message:"deleted book",deleted:!0,itemId:a.params.book_id}))})})}),routing.use(express["static"](__dirname+"/"+pubDirName)),docRoute.use(express["static"](__dirname+"/docs")),adminRoute.use(express["static"](__dirname+"/admin")),app.get("/hello",function(a,b){"use strict";b.send("Hello World!")}),routing.get(/^(.+)$/,function(a,b){"use strict";b.sendFile(__dirname+a.params[0],function(c,d){var e="<ul>";404===c.status&&fs.readdir(__dirname+"/"+pubDirName+a.params[0],function(a,c){return a?b.status(404).send("Not found"):(c.forEach(function(a){e+="<li>"+a+"</li>"}),e+="</ul>",void b.send(e))})})}),docRoute.get(/^(.+)$/,function(a,b){"use strict";b.sendFile(__dirname+a.params[0])}),app.use("/docs",docRoute),app.use("/api",router),app.use("/public",routing),app.use("/admin",adminRoute);var server=app.listen(port,function(){"use strict";var a=server.address().port;console.log("server listening at http://localhost:%s",a)});